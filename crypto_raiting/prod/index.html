<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Crypto Raiting</title>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <!-- <link href="https://fonts.googleapis.com/css?family=Oswald:200,300,400" rel="stylesheet"> -->
    <link rel="stylesheet" type="text/css" href="http://widgets/COMMON/styles/chartist/chartist.min.css">
    <style>.bubblingG {
  text-align: center;
  width: 78px;
  height: 49px;
  margin: auto;
}
.bubblingG span {
  display: inline-block;
  vertical-align: middle;
  width: 10px;
  height: 10px;
  margin: 24px auto;
  background: #000000;
  border-radius: 49px;
  -o-border-radius: 49px;
  -ms-border-radius: 49px;
  -webkit-border-radius: 49px;
  -moz-border-radius: 49px;
  animation: bubblingG 1.5s infinite alternate;
  -o-animation: bubblingG 1.5s infinite alternate;
  -ms-animation: bubblingG 1.5s infinite alternate;
  -webkit-animation: bubblingG 1.5s infinite alternate;
  -moz-animation: bubblingG 1.5s infinite alternate;
}
#bubblingG_1 {
  animation-delay: 0s;
  -o-animation-delay: 0s;
  -ms-animation-delay: 0s;
  -webkit-animation-delay: 0s;
  -moz-animation-delay: 0s;
}
#bubblingG_2 {
  animation-delay: 0.45s;
  -o-animation-delay: 0.45s;
  -ms-animation-delay: 0.45s;
  -webkit-animation-delay: 0.45s;
  -moz-animation-delay: 0.45s;
}
#bubblingG_3 {
  animation-delay: 0.9s;
  -o-animation-delay: 0.9s;
  -ms-animation-delay: 0.9s;
  -webkit-animation-delay: 0.9s;
  -moz-animation-delay: 0.9s;
}
@keyframes bubblingG {
  0% {
    width: 10px;
    height: 10px;
    background-color: #000000;
    -webkit-transform: translateY(0);
            transform: translateY(0);
  }
  100% {
    width: 23px;
    height: 23px;
    background-color: #ffffff;
    -webkit-transform: translateY(-20px);
            transform: translateY(-20px);
  }
}
@-webkit-keyframes bubblingG {
  0% {
    width: 10px;
    height: 10px;
    background-color: #000000;
    -webkit-transform: translateY(0);
  }
  100% {
    width: 23px;
    height: 23px;
    background-color: #ffffff;
    -webkit-transform: translateY(-20px);
  }
}
html,
body {
  margin: 0;
  padding: 0;
  width: 480px;
  height: 360px;
  box-sizing: border-box;
}
body {
  padding: 5px;
  background: url('https://dooh.xyz/bitrix/templates/eshop_bootstrap_black/images/bg.jpg') no-repeat;
  background-size: 100%;
}
div {
  box-sizing: border-box;
}
a {
  text-decoration: none;
  color: inherit;
}
.fake {
  display: inline-block;
  vertical-align: middle;
  height: 100%;
}
.placeholder {
  position: relative;
  width: 100%;
  height: 100%;
  overflow: hidden;
  font-family: 'Oswald', sans-serif;
  color: #222;
  box-sizing: border-box;
  border: 2px solid #b9d2f1;
}
.placeholder__bg {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
  z-index: 1;
}
.content {
  position: relative;
  width: 100%;
  z-index: 999;
  height: 100%;
  display: block;
  z-index: 2;
}
.content__header {
  position: absolute;
  width: 100%;
  top: 0;
  left: 0;
  padding: 10px 0 10px 0;
}
.content__title,
.content__icon {
  display: inline-block;
  vertical-align: middle;
  height: 35px;
}
.content__icon {
  width: 50px;
}
.content__icon img {
  display: block;
  width: 35px;
  margin: 0 auto;
}
.content__title {
  font-size: 35px;
  font-weight: bold;
  color: #8ab5ea;
}
.content__tooltip {
  position: absolute;
  font-size: 25px;
  opacity: 1;
  z-index: 1;
}
.content__tooltip-wrapper {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 300px;
}
.ct-chart {
  z-index: 2;
}
.ct-chart > svg {
  top: auto;
  bottom: 0;
}
.ct-point.min,
.ct-point.max {
  stroke-width: 17px;
}
.sorry {
  width: 100%;
  height: 100%;
  text-align: center;
}
.sorry img {
  max-height: 100%;
}
.preloader {
  display: none;
  position: absolute;
  top: 35%;
  margin-top: -48px;
  left: 50%;
  z-index: 99999;
}
</style>
</head>
<body>
    <div class="placeholder">

        <div class="content js-content">
            <div class="ct-chart ct-perfect-fourth"></div>
            <div class="content__header">
                <div class="content__icon js-icon"><img src=""></div>
                <div class="content__title js-title"></div>
            </div>
            <div class="content__tooltip-wrapper js-tooltip-wrapper">
                <div class="content__tooltip content__tooltip_min js-tooltip-min"></div>
                <div class="content__tooltip content__tooltip_max js-tooltip-max"></div>
            </div>
        </div>
        <div class="sorry"><img src="http://widgets/COMMON/images/sorry.gif"></div>
        <div class="cssload-wrapper preloader">
            <div class="cssload-square"></div>
            <div class="cssload-square"></div>
            <div class="cssload-square"></div>
            <div class="cssload-square"></div>
            <div class="cssload-square"></div>
        </div>
        <div class="placeholder__bg js-bg"></div>
    </div>
    <script type="text/javascript" src="http://widgets/COMMON/scripts/chartist/chartist.min.js"></script>
    <script>/* eslint no-console:0 */
/* eslint eqeqeq: 0 */

var $container = $('.js-content'),
    $block,
    $title = $('.js-title'),
    $icon = $('.js-icon'),
    $tooltipWrapper = $('.js-tooltip-wrapper');


var curentDate = new Date(),
    curentDateFormat = curentDate.getFullYear() + '-' + (curentDate.getMonth() + 1) + '-' + curentDate.getDate(),
    curentTimeFormat = curentDate.getHours() + ':' + curentDate.getMinutes();

var currency = [
    {
      name: 'Bitcoin',
      icon: 'https://cdn.coinranking.com/Sy33Krudb/btc.svg',
      color: '#f7931a'
    },
    {
      name: 'Ethereum',
      icon: 'https://cdn.coinranking.com/rk4RKHOuW/eth.svg',
      color: '#8c8c8c'
    },
    {
      name: 'Ripple',
      icon: 'https://cdn.coinranking.com/Bkuz9Hd_-/xrp.svg',
      color: '#046fa6'
    }
]

var chartOption = {
  height: 300
}

var delay = 30000;

function updateVars() {
    $container = $('.js-content');
    $block = $('.js-block');

    var data = [];
}



function init() {

    updateVars();

    try {
        $.ajax({
            url: 'http://widgets/crypto_raiting/prod/server/redirect.php',
            dataType: 'json',
            beforeSend: function() {
                time = new Date();
                startTime = time.getTime();
            },
            success: function(data) {

                var arr = {};
                var hiLow;
                var i = 0;
                var minPos = {};
                var maxPos = {};

                console.log(data);

                data = data[curentDateFormat];

                var resultArr = {};

                for (var cur in data) {
                  var labels = [],
                      series = [],
                      seriesArr = [];
                  for (var time in data[cur]) {
                    var raitTime = new Date(curentDateFormat + 'T' + time),
                        diff = curentDate - raitTime;

                    if (diff / 3600000 < 4) {
                      labels.push(time);
                      seriesArr.push(data[cur][time].price.replace(',', ''));
                    }
                  }

                  resultArr[cur] = {
                    labels: labels,
                    series: [seriesArr]
                  }
                }

                var chart = new Chartist.Line('.ct-chart', resultArr[currency[i].name], chartOption);

                $title.html(currency[i].name);
                $icon.find('img').attr('src', currency[i].icon);

                var timerId = setTimeout(function tick() {

                  if (i < currency.length - 1) {
                    i++;
                  } else {
                    i = 0;
                  }

                  chart.update(resultArr[currency[i].name], chartOption);

                  $title.html(currency[i].name);
                  $icon.find('img').attr('src', currency[i].icon);

                  timerId = setTimeout(tick, delay / currency.length);
                }, delay / currency.length);


                chart.on('draw', function(context) {

                  if (context.type == 'point' || context.type == 'line') {
                    context.element.attr({
                        style: 'stroke: ' + currency[i].color
                    });
                  }
                });

                chart.on('created', function() {
                  hiLow = getMinMax(resultArr[currency[i].name].series[0]);

                  $('.ct-point').each(function() {
                    var x1 = $(this).attr('x1'),
                        y1 = $(this).attr('y1'),
                        x2 = $(this).attr('x2'),
                        y2 = $(this).attr('y2'),
                        val = $(this).attr('ct:value');

                    if (val == hiLow.min) {
                      $(this).addClass('min');
                      createTooltip('min', x1, y1, x2, y2, val);
                    } else if (val == hiLow.max) {
                      $(this).addClass('max')
                      createTooltip('max', x1, y1, x2, y2, val);
                    }
                  })
                })
            }
        });
    } catch (err) {
        $container.hide();
        console.log('crypto_raiting ajax err', err);
    }

}

function createTooltip(lohi, x1, y1, x2, y2, val) {
  /*var contWidth = 466;
  var xMargin = 15;
  var yMargin = 15;

  var $tooltip = $('.js-tooltip-' + lohi);
  var x = parseInt(x1),
      y = parseInt(y1);

  $tooltip.html(val);

  var tooltipWidth = parseInt($tooltip.outerWidth());

  if (contWidth < parseInt(x1) + tooltipWidth + xMargin ) {
    x = x1 - tooltipWidth - xMargin;
  } else {
    x = x + xMargin;
  }

  $('.js-tooltip-' + lohi).css({
    "top": y1 - yMargin + 'px',
    "left": x + 'px'
  }).html(val);*/
}

function getMinMax(arr) {
  min = arr[0];
  max = min;
  for (i = 1; i < arr.length; ++i) {
      if (arr[i] > max) max = arr[i];
      if (arr[i] < min) min = arr[i];
  }

  return {min: min, max: max}
}

function random(min, max) {
    var rand = min - 0.5 + Math.random() * (max - min + 1)
    rand = Math.round(rand);
    return rand;
}

init();</script>
</body>

</html>